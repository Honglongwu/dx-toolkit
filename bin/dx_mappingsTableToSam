#!/usr/bin/env python

import dxpy
import math
from optparse import OptionParser


#Usage: sample input: dx_MappingsTableToSamBwa --table_id <gtable_id> --output <filename>
#Example: dx_MappingsTableToSamBwa --table_id gtable-9yZvF200000PYKJyV4k00005 --output mappings.sam

def main():

    parser = OptionParser("Usage: % mappings_id file_name")
    parser.add_option("--table_id", dest="mappings_id", help="Mappings table id to read from")
    parser.add_option("--output", dest="file_name", help="Name of file to write SAM to")
    (opts, args) = parser.parse_args()

    
    mappingsTable = dxpy.open_dxgtable(opts.mappings_id)
    
    try:
        originalContig = mappingsTable.get_details()['originalContigSet']
    except:
        raise Exception("The original reference genome must be attached as a detail")
    
    contigDetails = dxpy.DXRecord(originalContig).get_details()['contigs']
    contigNames = contigDetails['names']
    contigSizes = contigDetails['sizes']
    
    outputFile = open(opts.file_name, 'w')
    
    for i in range(len(contigNames)):
        outputFile.write("@SQ\tSN:"+contigNames[i]+"\tLN:"+str(contigSizes[i])+"\n")

    col = {}
    names = mappingsTable.get_col_names()   
    for i in range(len(names)):
        col[names[i]] = i+1
        
    for x in mappingsTable.iterate_rows():
        flag = 0x1*(x[col["mate_id"]] >= -1 and x[col["mate_id"]] <= 1) + 0x2*(x[col["proper_pair"]] == True) + 0x4*(x[col["status"]] == "UNMAPPED")
        flag += 0x8*(x[col["status2"]] == "UNMAPPED") + 0x10*(x[col["negative_strand"]] == True) + 0x20*(x[col["negative_strand2"]] == True)
        flag += 0x40*(x[col["mate_id"]] == 0) + 0x80*(x[col["mate_id"]] == 1) + 0x100*(x[col["status"]] == "SECONDARY")
        flag += 0x200*(x[col["qc"]] == "not passing quality controls") + 0x400*(x[col["qc"]] == "PCR or optical duplicate")
        flag += (0x200+0x400)*(x[col["qc"]] == "both not qc and PCR or optical duplicate")

        outputFile.write(x[col["name"]].strip("@") + "\t" + str(flag) + "\t" + x[col["chr"]] + "\t" + str(x[col["lo"]]+1) + "\t")
        outputFile.write(str(x[col["error_probability"]]) + "\t" + x[col["cigar"]] + "\t" + x[col["chr2"]] + "\t")
        outputFile.write(str(x[col["lo2"]]+1) + "\t" + str(int(math.fabs(x[col["hi"]] - x[col["lo"]]))) + "\t" + x[col["sequence"]] + "\t")
        outputFile.write(str(x[col["quality"]] + "\n"))
        

main()
        