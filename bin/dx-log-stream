#!/usr/bin/env python

import os, sys, logging, argparse
import dxpy

logging.basicConfig(level=logging.DEBUG, format="%(message)s")

parser = argparse.ArgumentParser(usage="%prog [options]", description="Redirects stdin to a DNAnexus log socket in the execution environment.")
parser.add_argument("-p", "--prefix", help="Prefix lines from the stream with this tag", default='')
parser.add_argument("-l", "--level", help="Logging level to use", default='info')
args = parser.parse_args()

try:
    log_function = logging.__dict__[args.level]
except:
    log_function = logging.info

try:
    logging.getLogger().addHandler(dxpy.DXLogHandler())
except:
    print >> sys.stderr, "dx_log_stream: Error while initializing logging"
    sys.exit(1)

for line in sys.stdin:
    # print "Logging line:", line.rstrip("\n"), "to log handler w/level", args.level, "prefix", args.prefix
    log_function(args.prefix + line.rstrip("\n"))
