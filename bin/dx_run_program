#!/usr/bin/env python

import logging
logging.basicConfig(level=logging.DEBUG)
logging.getLogger('requests.packages.urllib3.connectionpool').setLevel(logging.ERROR)

import os, sys, json
from optparse import OptionParser
import dxpy
from dxpy.exceptions import DXJobFailureError

parser = OptionParser(usage="%prog program_name [options]", description="Run a DNAnexus program. Example: %prog my_program -iparam1=value1 -iparam2=value2")
parser.add_option("-i", "--input", help="Program input parameter", action='append')
parser.add_option("-w", "--wait", help="Wait for the launched job to complete, exit with code 1 if job fails", action='store_true')
(opts, args) = parser.parse_args()

if len(args) != 1:
    parser.print_help()
    parser.error("Incorrect number of arguments")

program_name = args[0]

try:
    program_id = dxpy.find_data_objects(classname="program", properties={"name": program_name}).next()['id']
except StopIteration:
    try:
        dxpy.describe(program_name)
        program_id = program_name
    except dxpy.exceptions.DXError:
        sys.exit("Unable to find program "+program_name)

program_input = {}
if opts.input:
    for i in opts.input:
        name, value = i.split("=")
        try:
            program_input[name] = json.loads(value)
        except ValueError:
            program_input[name] = value

job = dxpy.DXProgram(program_id).run(program_input)

logging.info("Launched job "+job.get_id())

if opts.wait:
    logging.info("Waiting for job to complete...")
    try:
        job.wait_on_done()
        print json.dumps(job.describe()["output"])
    except DXJobFailureError as e:
        logging.error("Job did not complete successfully: %s" % e.message)
        sys.exit(1)
