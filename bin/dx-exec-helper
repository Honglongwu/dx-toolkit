#!/bin/bash -e

# This script is executed by the DNAnexus Execution Manager when running applications inside the Execution Environment.

shopt -s nullglob

dhclient

[[ -e /etc/profile.d/dnanexus.environment ]] && source /etc/profile.d/dnanexus.environment
[[ -e /opt/dnanexus/environment ]] && source /opt/dnanexus/environment

for i in /etc/dnanexus-env.d/*; do
    source $i
done

[[ -e dx_stdout ]] || mkfifo dx_stdout 
[[ -e dx_stderr ]] || mkfifo dx_stderr

dx-log-stream -p stdout: < dx_stdout &
HELPER1_PID=$!
dx-log-stream -p stderr: -l warn < dx_stderr &
HELPER2_PID=$!

stop_helpers() {
    set +e
    kill $HELPER1_PID 2>/dev/null
    kill $HELPER2_PID 2>/dev/null
    pkill dhclient
    kill -9 $HELPER1_PID 2>/dev/null
    kill -9 $HELPER2_PID 2>/dev/null
}

trap stop_helpers EXIT

$@ > dx_stdout 2> dx_stderr
